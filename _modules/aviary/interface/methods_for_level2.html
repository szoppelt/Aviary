
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aviary.interface.methods_for_level2</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/aviary/interface/methods_for_level2';</script>
    <link rel="icon" href="../../../_static/aviary_logo.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/aviary.png" class="logo__image only-light" alt=" - Home"/>
    <script>document.write(`<img src="../../../_static/aviary.png" class="logo__image only-dark" alt=" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    Aviary Documentation
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/installation.html">Installation</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/what_aviary_does.html">What Aviary Does</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/tools_that_aviary_uses.html">Tools That Aviary is Built Upon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/expected_user_knowledge.html">Expected User Knowledge</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../getting_started/onboarding.html">Onboarding Guide</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/onboarding_level1.html">Level 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/onboarding_level2.html">Level 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/onboarding_level3.html">Level 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/onboarding_ext_subsystem.html">Models with External Subsystems</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/input_csv_phase_info.html">Vehicle Input .csv File and Phase_info Dictionary</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/now_what.html">Now What?</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../user_guide/user_interface.html">Aviary User Interface</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/UI_Levels.html">User Interface Levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/examples_of_the_same_mission_at_different_UI_levels.html">Examples of the same mission at different UI levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/aviary_commands.html">Command Line Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/input_files.html">Input Files</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/drawing_and_running_simple_missions.html">Drawing and running simple missions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/pre_mission_and_mission.html">Pre-Mission and Mission</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/postprocessing_and_visualizing_results.html">Postprocessing and Visualizing Results from Aviary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/variable_metadata.html">Understanding the Variable Metadata</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../user_guide/features_and_functionalities.html">Features and Functionalities</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/aerodynamics.html">Aerodynamics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/external_aero.html">Externally Computed Polars</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../user_guide/propulsion.html">Propulsion</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/creating_a_turboprop_engine.html">Creating a Turboprop Powered Aircraft Example</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/hamilton_standard.html">Hamilton Standard Propulsion Model</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/mass.html">Mass Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/subsystems.html">SubsystemBuilderBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/using_external_subsystems.html">Using external subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/step_by_step_external_guide.html">Step-by-step guide for creating, testing, and using external subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/battery_subsystem_example.html">In-depth look at the battery subsystem as an example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/features/overriding.html">Overriding Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/FLOPS_based_detailed_takeoff_and_landing.html">FLOPS Based Detailed Takeoff and Landing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/reserve_missions.html">Reserve Mission</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/multi_mission.html">Multi-Mission Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/off_design_missions.html">Off-Design Missions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/SGM_capabilities.html">Key SGM Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/blended_wing_body.html">Blended Wing Body Modeling</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../examples/intro.html">Discussing the Aviary Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/simple_mission_example.html">Conventional Aircraft and Simple Mission</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/more_advanced_example.html">Optimizing the Mission Profile of a Conventional Aircraft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/coupled_aircraft_mission_optimization.html">Coupled Aircraft-Mission Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/additional_flight_phases.html">Mission Optimization with Many Phases for a Commercial Aircraft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/reserve_missions.html">Reserve Mission Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/multi_mission.html">Multi-Mission Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/off_design_example.html">Off-Design Mission Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/OAS_subsystem.html">Using Aviary and OpenAeroStruct Together</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/level_2_detailed_takeoff_and_landing.html">Level 2 Detailed Takeoff and Landing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Theory Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../theory_guide/intro.html">Overview of Aviary Functionality</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../theory_guide/underlying_concepts.html">Underlying Concepts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/assumptions.html">Assumptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/aerodynamics.html">Core Aerodynamics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/geometry.html">Core Geometry Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/mass.html">Core Mass Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/mission.html">Mission Analysis</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../theory_guide/propulsion.html">Core Propulsion Subsystem</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../theory_guide/turboprop.html">The Turboprop Model</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory_guide/optimization_algorithms.html">Optimization Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory_guide/validation.html">Validation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/codebase_overview.html">Codebase Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/coding_standards.html">Coding Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/ai_policy.html">Aviaryâ€™s AI Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/unit_tests.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/contributing_guidelines.html">Guidelines for Contributing Code</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../developer_guide/how_to_contribute_docs.html">How to Contribute Docs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../developer_guide/doctape.html">DocTAPE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developer_guide/doctape_examples.html">DocTAPE Examples</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/debugging_env_from_github.html">Using Dev Environments from GitHub Actions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Miscellaneous Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/modeling_exercise.html">Modeling Exercise for the Usability Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/externally_supported_subsystems.html">Externally Supported Subsystems</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../misc_resources/feature_comparison.html">Feature Comparison with Legacy Codes</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../misc_resources/comparison_to_flops.html">Comparison to FLOPS</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/planned_future_features.html">Planned Future Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_srcdocs/index.html">Source Docs</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/openmdao/Aviary" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/openmdao/Aviary/issues/new?title=Issue%20on%20page%20%2F_modules/aviary/interface/methods_for_level2.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for aviary.interface.methods_for_level2</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dymos</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openmdao.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">om</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dymos.utils.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">_unspecified</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openmdao.utils.reports_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">_default_reports</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.core.AviaryGroup</span><span class="w"> </span><span class="kn">import</span> <span class="n">AviaryGroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.core.PostMissionGroup</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostMissionGroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.core.PreMissionGroup</span><span class="w"> </span><span class="kn">import</span> <span class="n">PreMissionGroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.interface.default_phase_info.two_dof_fiti</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_default_sgm_args</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.interface.utils.check_phase_info</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_phase_info</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.mission.gasp_based.phases.time_integration_traj</span><span class="w"> </span><span class="kn">import</span> <span class="n">FlexibleTraj</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.mission.height_energy_problem_configurator</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeightEnergyProblemConfigurator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.mission.solved_two_dof_problem_configurator</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolvedTwoDOFProblemConfigurator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.mission.two_dof_problem_configurator</span><span class="w"> </span><span class="kn">import</span> <span class="n">TwoDOFProblemConfigurator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.subsystems.aerodynamics.aerodynamics_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoreAerodynamicsBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.subsystems.geometry.geometry_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoreGeometryBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.subsystems.mass.mass_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoreMassBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.subsystems.premission</span><span class="w"> </span><span class="kn">import</span> <span class="n">CorePreMission</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.subsystems.propulsion.propulsion_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">CorePropulsionBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.utils.aviary_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">AviaryValues</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.utils.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert_strings_to_data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.utils.merge_variable_metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">merge_meta_data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.utils.preprocessors</span><span class="w"> </span><span class="kn">import</span> <span class="n">preprocess_options</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.utils.process_input_decks</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_vehicle</span><span class="p">,</span> <span class="n">update_GASP_options</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrapped_convert_units</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.variable_info.enums</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AnalysisScheme</span><span class="p">,</span>
    <span class="n">EquationsOfMotion</span><span class="p">,</span>
    <span class="n">LegacyCode</span><span class="p">,</span>
    <span class="n">ProblemType</span><span class="p">,</span>
    <span class="n">Verbosity</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.variable_info.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_model_options</span><span class="p">,</span> <span class="n">setup_trajectory_params</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.variable_info.variable_meta_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">_MetaData</span> <span class="k">as</span> <span class="n">BaseMetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aviary.variable_info.variables</span><span class="w"> </span><span class="kn">import</span> <span class="n">Aircraft</span><span class="p">,</span> <span class="n">Dynamic</span><span class="p">,</span> <span class="n">Mission</span><span class="p">,</span> <span class="n">Settings</span>

<span class="n">FLOPS</span> <span class="o">=</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">FLOPS</span>
<span class="n">GASP</span> <span class="o">=</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">GASP</span>

<span class="n">TWO_DEGREES_OF_FREEDOM</span> <span class="o">=</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">TWO_DEGREES_OF_FREEDOM</span>
<span class="n">HEIGHT_ENERGY</span> <span class="o">=</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">HEIGHT_ENERGY</span>
<span class="n">SOLVED_2DOF</span> <span class="o">=</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">SOLVED_2DOF</span>
<span class="n">CUSTOM</span> <span class="o">=</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">CUSTOM</span>


<div class="viewcode-block" id="AviaryProblem">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AviaryProblem</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">Problem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for instantiating, formulating, and solving Aviary problems.</span>

<span class="sd">    On a basic level, this problem object is all the conventional user needs</span>
<span class="sd">    to interact with. Looking at the three &quot;levels&quot; of use cases, from simplest</span>
<span class="sd">    to most complicated, we have:</span>

<span class="sd">    Level 1: users interact with Aviary through input files (.csv or .yaml, TBD)</span>
<span class="sd">    Level 2: users interact with Aviary through a Python interface</span>
<span class="sd">    Level 3: users can modify Aviary&#39;s workings through Python and OpenMDAO</span>

<span class="sd">    This Problem object is simply a specialized OpenMDAO Problem that has</span>
<span class="sd">    additional methods to help users create and solve Aviary problems.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AviaryProblem.__init__">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_scheme</span><span class="o">=</span><span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Modify OpenMDAO&#39;s default_reports for this session.</span>
        <span class="n">new_reports</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;subsystems&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mission&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timeseries_csv&#39;</span><span class="p">,</span>
            <span class="s1">&#39;run_status&#39;</span><span class="p">,</span>
            <span class="s1">&#39;input_checks&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">new_reports</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">report</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_default_reports</span><span class="p">:</span>
                <span class="n">_default_reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AviaryGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission</span> <span class="o">=</span> <span class="n">PreMissionGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span> <span class="o">=</span> <span class="n">PostMissionGroup</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="o">=</span> <span class="n">analysis_scheme</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AviaryProblem.load_inputs">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.load_inputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">aircraft_data</span><span class="p">,</span>
        <span class="n">phase_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">engine_builders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">problem_configurator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">meta_data</span><span class="o">=</span><span class="n">BaseMetaData</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method loads the aviary_values inputs and options that the</span>
<span class="sd">        user specifies. They could specify files to load and values to</span>
<span class="sd">        replace here as well.</span>
<span class="sd">        Phase info is also loaded if provided by the user. If phase_info is None,</span>
<span class="sd">        the appropriate default phase_info based on mission analysis method is used.</span>

<span class="sd">        This method is not strictly necessary; a user could also supply</span>
<span class="sd">        an AviaryValues object and/or phase_info dict of their own.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We haven&#39;t read the input data yet, we don&#39;t know what desired run verbosity is</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># usually None</span>

        <span class="c1">## LOAD INPUT FILE ###</span>
        <span class="c1"># Create AviaryValues object from file (or process existing AviaryValues object</span>
        <span class="c1"># with default values from metadata) and generate initial guesses</span>
        <span class="n">aviary_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialization_guesses</span> <span class="o">=</span> <span class="n">create_vehicle</span><span class="p">(</span>
            <span class="n">aircraft_data</span><span class="p">,</span> <span class="n">meta_data</span><span class="o">=</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span>
        <span class="p">)</span>

        <span class="c1"># update verbosity now that we have read the input data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">VERBOSITY</span><span class="p">)</span>
        <span class="c1"># if user did not ask for verbosity override for this method, use value from data</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">VERBOSITY</span><span class="p">)</span>

        <span class="c1"># Now that the input file has been read, we have the desired verbosity for this</span>
        <span class="c1"># run stored in aviary_inputs. Save this to self.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span> <span class="o">=</span> <span class="n">aviary_inputs</span>

        <span class="c1"># pull which methods will be used for subsystems and mission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="o">=</span> <span class="n">mission_method</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">EQUATIONS_OF_MOTION</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_method</span> <span class="o">=</span> <span class="n">mass_method</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">MASS_METHOD</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_method</span> <span class="o">=</span> <span class="n">aero_method</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">AERODYNAMICS_METHOD</span><span class="p">)</span>

        <span class="c1"># Create engine_builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_builders</span> <span class="o">=</span> <span class="n">engine_builders</span>

        <span class="c1"># Determine which problem configurator to use based on mission_method</span>
        <span class="k">if</span> <span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">HeightEnergyProblemConfigurator</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">TwoDOFProblemConfigurator</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">mission_method</span> <span class="ow">is</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">SolvedTwoDOFProblemConfigurator</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">mission_method</span> <span class="ow">is</span> <span class="n">CUSTOM</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">problem_configurator</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">problem_configurator</span><span class="p">()</span>
                <span class="c1"># TODO: make draft / example custom builder</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;When using &quot;settings:equations_of_motion,custom&quot;, a &#39;</span>
                    <span class="s1">&#39;problem_configurator must be specified in load_inputs().&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;settings:equations_of_motion must be one of: height_energy, 2DOF, &#39;</span>
                <span class="s1">&#39;solved_2DOF, or custom&#39;</span>
            <span class="p">)</span>

        <span class="c1"># TODO this should be a preprocessor step if it is required here</span>
        <span class="k">if</span> <span class="n">mass_method</span> <span class="ow">is</span> <span class="n">GASP</span> <span class="ow">or</span> <span class="n">aero_method</span> <span class="ow">is</span> <span class="n">GASP</span><span class="p">:</span>
            <span class="n">aviary_inputs</span> <span class="o">=</span> <span class="n">update_GASP_options</span><span class="p">(</span><span class="n">aviary_inputs</span><span class="p">)</span>

        <span class="c1">## LOAD PHASE_INFO ###</span>
        <span class="k">if</span> <span class="n">phase_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check if the user generated a phase_info from gui</span>
            <span class="c1"># Load the phase info dynamically from the current working directory</span>
            <span class="n">phase_info_module_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;outputted_phase_info.py&#39;</span>

            <span class="k">if</span> <span class="n">phase_info_module_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span>
                    <span class="s1">&#39;outputted_phase_info&#39;</span><span class="p">,</span> <span class="n">phase_info_module_path</span>
                <span class="p">)</span>
                <span class="n">outputted_phase_info</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;outputted_phase_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputted_phase_info</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">outputted_phase_info</span><span class="p">)</span>

                <span class="c1"># Access the phase_info variable from the loaded module</span>
                <span class="n">phase_info</span> <span class="o">=</span> <span class="n">outputted_phase_info</span><span class="o">.</span><span class="n">phase_info</span>

                <span class="c1"># if verbosity level is BRIEF or higher, print that we&#39;re using the</span>
                <span class="c1"># outputted phase info</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using outputted phase_info from current working directory&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_default_phase_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;Loaded default phase_info for &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1"> equations of motion&#39;</span>
                    <span class="p">)</span>

        <span class="c1"># create a new dictionary that only contains the phases from phase_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phase_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;external_subsystems&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pre_mission&#39;</span><span class="p">,</span> <span class="s1">&#39;post_mission&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>

        <span class="c1"># pre_mission and post_mission are stored in their own dictionaries.</span>
        <span class="k">if</span> <span class="s1">&#39;pre_mission&#39;</span> <span class="ow">in</span> <span class="n">phase_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span> <span class="o">=</span> <span class="n">phase_info</span><span class="p">[</span><span class="s1">&#39;pre_mission&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;post_mission&#39;</span> <span class="ow">in</span> <span class="n">phase_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span> <span class="o">=</span> <span class="n">phase_info</span><span class="p">[</span><span class="s1">&#39;post_mission&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">PROBLEM_TYPE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">initial_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># This function sets all the following defaults if they were not already set</span>
        <span class="c1"># self.engine_builders, self.pre_mission_info, self_post_mission_info</span>
        <span class="c1"># self.require_range_residual, self.target_range</span>
        <span class="c1"># Other specific self.*** are defined in here as well that are specific to</span>
        <span class="c1"># each builder</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span></div>


<div class="viewcode-block" id="AviaryProblem.check_and_preprocess_inputs">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.check_and_preprocess_inputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_and_preprocess_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method checks the user-supplied input values for any potential problems</span>
<span class="sd">        and preprocesses the inputs to prepare them for use in the Aviary problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="n">aviary_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span>
        <span class="c1"># Target_distance verification for all phases</span>
        <span class="c1"># Checks to make sure target_distance is positive,</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;user_options&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;target_distance&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]:</span>
                    <span class="n">target_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;target_distance&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">target_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;Invalid target_distance in [</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">].[user_options]. &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;Current (value: </span><span class="si">{</span><span class="n">target_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">), &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;(units: </span><span class="si">{</span><span class="n">target_distance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">) &lt;= 0&#39;</span>
                        <span class="p">)</span>

        <span class="c1"># Checks to make sure target_duration is positive,</span>
        <span class="c1"># Sets duration_bounds, initial_guesses, and fixed_duration</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;user_options&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="n">analytic</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">TWO_DEGREES_OF_FREEDOM</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># if the user provided an option, use it</span>
                        <span class="n">analytic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;analytic&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c1"># if it isn&#39;t specified, only the default 2DOF cruise for</span>
                        <span class="c1"># collocation is analytic</span>
                        <span class="k">if</span> <span class="s1">&#39;cruise&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                            <span class="n">analytic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;analytic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="kc">True</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">analytic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;analytic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="kc">False</span>
                            <span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;target_duration&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]:</span>
                    <span class="n">target_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;target_duration&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;Invalid target_duration in phase_info[</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">]&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;[user_options]. Current (value: </span><span class="si">{</span><span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">), &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;(units: </span><span class="si">{</span><span class="n">target_duration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">) &lt;= 0&quot;)&#39;</span>
                        <span class="p">)</span>

                    <span class="c1"># Only applies to non-analytic phases (all HE and most 2DOF)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">analytic</span><span class="p">:</span>
                        <span class="c1"># Set duration_bounds and initial_guesses for time:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s1">&#39;duration_bounds&#39;</span><span class="p">:</span> <span class="p">(</span>
                                    <span class="p">(</span><span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                    <span class="n">target_duration</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s1">&#39;initial_guesses&#39;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">(</span>
                                        <span class="p">(</span><span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                        <span class="n">target_duration</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="p">)</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="c1"># Set Fixed_duration to true:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;fix_duration&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
            <span class="n">check_phase_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]:</span>
                <span class="n">aviary_inputs</span> <span class="o">=</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">preprocess_inputs</span><span class="p">(</span><span class="n">aviary_inputs</span><span class="p">)</span>

        <span class="c1"># PREPROCESSORS #</span>
        <span class="c1"># BUG we can&#39;t provide updated metadata to preprocessors, because we need the</span>
        <span class="c1">#     processed options to build our subsystems to begin with</span>
        <span class="n">preprocess_options</span><span class="p">(</span>
            <span class="n">aviary_inputs</span><span class="p">,</span>
            <span class="n">engine_models</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_builders</span><span class="p">,</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
            <span class="c1"># metadata=self.meta_data</span>
        <span class="p">)</span>

        <span class="c1">## Set Up Core Subsystems ##</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">CorePropulsionBuilder</span><span class="p">(</span><span class="s1">&#39;core_propulsion&#39;</span><span class="p">,</span> <span class="n">engine_models</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_builders</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">CoreMassBuilder</span><span class="p">(</span><span class="s1">&#39;core_mass&#39;</span><span class="p">,</span> <span class="n">code_origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_method</span><span class="p">)</span>

        <span class="c1"># If all phases ask for tabular aero, we can skip pre-mission. Check phase_info</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;pre_mission&#39;</span><span class="p">,</span> <span class="s1">&#39;post_mission&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="s1">&#39;tabular&#39;</span>
                        <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;subsystem_options&#39;</span><span class="p">][</span><span class="s1">&#39;core_aerodynamics&#39;</span><span class="p">][</span>
                            <span class="s1">&#39;method&#39;</span>
                        <span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">tabular</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">tabular</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">aero</span> <span class="o">=</span> <span class="n">CoreAerodynamicsBuilder</span><span class="p">(</span>
            <span class="s1">&#39;core_aerodynamics&#39;</span><span class="p">,</span> <span class="n">code_origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_method</span><span class="p">,</span> <span class="n">tabular</span><span class="o">=</span><span class="n">tabular</span>
        <span class="p">)</span>

        <span class="c1"># which geometry methods should be used?</span>
        <span class="n">geom_code_origin</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_method</span> <span class="ow">is</span> <span class="n">FLOPS</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_method</span> <span class="ow">is</span> <span class="n">FLOPS</span><span class="p">):</span>
            <span class="n">geom_code_origin</span> <span class="o">=</span> <span class="n">FLOPS</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_method</span> <span class="ow">is</span> <span class="n">GASP</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_method</span> <span class="ow">is</span> <span class="n">GASP</span><span class="p">):</span>
            <span class="n">geom_code_origin</span> <span class="o">=</span> <span class="n">GASP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geom_code_origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">FLOPS</span><span class="p">,</span> <span class="n">GASP</span><span class="p">)</span>

        <span class="c1"># which geometry method gets prioritized in case of conflicting outputs</span>
        <span class="n">code_origin_to_prioritize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_code_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">geom</span> <span class="o">=</span> <span class="n">CoreGeometryBuilder</span><span class="p">(</span>
            <span class="s1">&#39;core_geometry&#39;</span><span class="p">,</span>
            <span class="n">code_origin</span><span class="o">=</span><span class="n">geom_code_origin</span><span class="p">,</span>
            <span class="n">code_origin_to_prioritize</span><span class="o">=</span><span class="n">code_origin_to_prioritize</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;propulsion&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">,</span>
            <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">geom</span><span class="p">,</span>
            <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">mass</span><span class="p">,</span>
            <span class="s1">&#39;aerodynamics&#39;</span><span class="p">:</span> <span class="n">aero</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># TODO optionally accept which subsystems to load from phase_info</span>
        <span class="n">default_mission_subsystems</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;aerodynamics&#39;</span><span class="p">],</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;propulsion&#39;</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ode_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;aviary_options&#39;</span><span class="p">:</span> <span class="n">aviary_inputs</span><span class="p">,</span>
            <span class="s1">&#39;core_subsystems&#39;</span><span class="p">:</span> <span class="n">default_mission_subsystems</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_metadata_from_subsystems</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_reserve_phase_separation</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_metadata_from_subsystems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge metadata from user-defined subsystems into problem metadata.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">BaseMetaData</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># loop through phase_info and external subsystems</span>
        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">:</span>
            <span class="n">external_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">external_subsystems</span><span class="p">:</span>
                <span class="n">meta_data</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">merge_meta_data</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_reserve_phase_separation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method checks for reserve=True &amp; False</span>
<span class="sd">        Returns an error if a non-reserve phase is specified after a reserve phase.</span>
<span class="sd">        return two dictionaries of phases: regular_phases and reserve_phases</span>
<span class="sd">        For shooting trajectories, this will also check if a phase is part of the descent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check to ensure no non-reserve phases are specified after reserve phases</span>
        <span class="n">start_reserve</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">raise_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;user_options&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;reserve&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;reserve&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="c1"># This is a regular phase</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">start_reserve</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">raise_error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># This is a reserve phase</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
                        <span class="n">start_reserve</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This is a regular phase by default</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">start_reserve</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">raise_error</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">raise_error</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;In phase_info, reserve=False cannot be specified after a phase where &#39;</span>
                <span class="s1">&#39;reserve=True. All reserve phases must happen after non-reserve phases. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Regular Phases : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="si">}</span><span class="s1"> | &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Reserve Phases : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descent_phases</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">descent</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;descent_phase&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">descent</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">descent_phases</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

<div class="viewcode-block" id="AviaryProblem.add_pre_mission_systems">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_pre_mission_systems">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_pre_mission_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add pre-mission systems to the Aviary problem. These systems are executed before</span>
<span class="sd">        the mission.</span>

<span class="sd">        Depending on the mission model specified (`FLOPS` or `GASP`), this method adds</span>
<span class="sd">        various subsystems to the aircraft model. For the `FLOPS` mission model, a</span>
<span class="sd">        takeoff phase is added using the Takeoff class with the number of engines and</span>
<span class="sd">        airport altitude specified. For the `GASP` mission model, three subsystems are</span>
<span class="sd">        added: a TaxiSegment subsystem, an ExecComp to calculate the time to initiate</span>
<span class="sd">        gear and flaps, and an ExecComp to calculate the speed at which to initiate</span>
<span class="sd">        rotation. All subsystems are promoted with aircraft and mission inputs and</span>
<span class="sd">        outputs as appropriate.</span>

<span class="sd">        A user can override this method with their own pre-mission systems as desired.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="n">pre_mission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;pre_mission&#39;</span><span class="p">,</span>
            <span class="n">pre_mission</span><span class="p">,</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aircraft:*&#39;</span><span class="p">,</span> <span class="s1">&#39;mission:*&#39;</span><span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aircraft:*&#39;</span><span class="p">,</span> <span class="s1">&#39;mission:*&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;linear_solver&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">:</span>
            <span class="n">pre_mission</span><span class="o">.</span><span class="n">linear_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;nonlinear_solver&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">:</span>
            <span class="n">pre_mission</span><span class="o">.</span><span class="n">nonlinear_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;nonlinear_solver&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_premission_external_subsystems</span><span class="p">()</span>

        <span class="n">subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span>

        <span class="c1"># Propulsion isn&#39;t included in core pre-mission group to avoid override step in</span>
        <span class="c1"># configure() - instead add it now</span>
        <span class="n">pre_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;core_propulsion&#39;</span><span class="p">,</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;propulsion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">build_pre_mission</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">default_subsystems</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;aerodynamics&#39;</span><span class="p">],</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="n">pre_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;core_subsystems&#39;</span><span class="p">,</span>
            <span class="n">CorePreMission</span><span class="p">(</span>
                <span class="n">aviary_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span>
                <span class="n">subsystems</span><span class="o">=</span><span class="n">default_subsystems</span><span class="p">,</span>
                <span class="n">process_overrides</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;include_takeoff&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">add_takeoff_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_add_premission_external_subsystems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This private method adds each external subsystem to the pre-mission subsystem and</span>
<span class="sd">        a mass component that captures external subsystem masses for use in mass buildups.</span>

<span class="sd">        Firstly, the method iterates through all external subsystems in the pre-mission</span>
<span class="sd">        information. For each subsystem, it builds the pre-mission instance of the</span>
<span class="sd">        subsystem.</span>

<span class="sd">        Secondly, the method collects the mass names of the added subsystems. This</span>
<span class="sd">        expression is then used to define an ExecComp (a component that evaluates a</span>
<span class="sd">        simple equation given input values).</span>

<span class="sd">        The method promotes the input and output of this ExecComp to the top level of the</span>
<span class="sd">        pre-mission object, allowing this calculated subsystem mass to be accessed</span>
<span class="sd">        directly from the pre-mission object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mass_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Loop through all the phases in this subsystem.</span>
        <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]:</span>
            <span class="c1"># Get all the subsystem builders for this phase.</span>
            <span class="n">subsystem_premission</span> <span class="o">=</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">build_pre_mission</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">subsystem_premission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">subsystem_premission</span><span class="p">)</span>

                <span class="n">mass_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">get_mass_names</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">mass_names</span><span class="p">:</span>
            <span class="n">formatted_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mass_names</span><span class="p">:</span>
                <span class="n">formatted_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">formatted_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted_name</span><span class="p">)</span>

            <span class="c1"># Define the expression for computing the sum of masses</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;subsystem_mass = &#39;</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_names</span><span class="p">)</span>

            <span class="n">promotes_inputs_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">formatted_name</span><span class="p">,</span> <span class="n">original_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">formatted_name</span><span class="p">,</span> <span class="n">original_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">formatted_names</span><span class="p">,</span> <span class="n">mass_names</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># Create the ExecComp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="s1">&#39;external_comp_sum&#39;</span><span class="p">,</span>
                <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">),</span>
                <span class="n">promotes_inputs</span><span class="o">=</span><span class="n">promotes_inputs_list</span><span class="p">,</span>
                <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;subsystem_mass&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">EXTERNAL_SUBSYSTEMS_MASS</span><span class="p">)],</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_idx</span><span class="p">):</span>
        <span class="n">base_phase_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>

        <span class="c1"># We need to exclude some things from the phase_options that we pass down</span>
        <span class="c1"># to the phases. Instead of &quot;popping&quot; keys, we just create new outer</span>
        <span class="c1"># dictionaries.</span>

        <span class="n">phase_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">base_phase_options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">phase_options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">base_phase_options</span><span class="p">[</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># TODO optionally accept which subsystems to load from phase_info</span>
        <span class="n">subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span>
        <span class="n">default_mission_subsystems</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;aerodynamics&#39;</span><span class="p">],</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;propulsion&#39;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="n">phase_builder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_phase_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_options</span><span class="p">)</span>

        <span class="n">phase_object</span> <span class="o">=</span> <span class="n">phase_builder</span><span class="o">.</span><span class="n">from_phase_info</span><span class="p">(</span>
            <span class="n">phase_name</span><span class="p">,</span>
            <span class="n">phase_options</span><span class="p">,</span>
            <span class="n">default_mission_subsystems</span><span class="p">,</span>
            <span class="n">meta_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase_object</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="n">aviary_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phase_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_object</span><span class="p">)</span>

        <span class="c1"># TODO: add logic to filter which phases get which controls.</span>
        <span class="c1"># right now all phases get all controls added from every subsystem.</span>
        <span class="c1"># for example, we might only want ELECTRIC_SHAFT_POWER applied during the</span>
        <span class="c1"># climb phase.</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span><span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>

        <span class="c1"># loop through all_subsystems and call `get_controls` on each subsystem</span>
        <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="c1"># add the controls from the subsystems to each phase</span>
            <span class="n">arg_spec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phase_name&#39;</span> <span class="ow">in</span> <span class="n">arg_spec</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">control_dicts</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control_dicts</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">control_name</span><span class="p">,</span> <span class="n">control_dict</span> <span class="ow">in</span> <span class="n">control_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">add_control</span><span class="p">(</span><span class="n">control_name</span><span class="p">,</span> <span class="o">**</span><span class="n">control_dict</span><span class="p">)</span>

        <span class="n">user_options</span> <span class="o">=</span> <span class="n">AviaryValues</span><span class="p">(</span><span class="n">phase_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_options&#39;</span><span class="p">,</span> <span class="p">()))</span>

        <span class="c1"># TODO: Should some of this stuff be moved into the phase builder?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">set_phase_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_idx</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">user_options</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">phase</span>

<div class="viewcode-block" id="AviaryProblem.add_phases">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_phases">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_info_parameterization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parallel_phases</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the mission phases to the problem trajectory based on the user-specified</span>
<span class="sd">        phase_info dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase_info_parameterization (function, optional): A function that takes in the</span>
<span class="sd">            phase_info dictionary and aviary_inputs and returns modified phase_info.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">        parallel_phases (bool, optional): If True, the top-level container of all phases</span>
<span class="sd">            will be a ParallelGroup, otherwise it will be a standard OpenMDAO Group.</span>
<span class="sd">            Defaults to True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        traj: The Dymos Trajectory object containing the added mission phases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="k">if</span> <span class="n">phase_info_parameterization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span> <span class="o">=</span> <span class="n">phase_info_parameterization</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span>
            <span class="p">)</span>

        <span class="n">phase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;traj&#39;</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">parallel_phases</span><span class="o">=</span><span class="n">parallel_phases</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
            <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">VERBOSITY</span><span class="p">)</span>
            <span class="n">add_default_sgm_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_args</span><span class="p">,</span> <span class="n">vb</span><span class="p">)</span>

            <span class="n">full_traj</span> <span class="o">=</span> <span class="n">FlexibleTraj</span><span class="p">(</span>
                <span class="n">Phases</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span>
                <span class="n">traj_final_state_output</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Vehicle</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">traj_initial_state_input</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Vehicle</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">,</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">traj_event_trigger_input</span><span class="o">=</span><span class="p">[</span>
                    <span class="c1"># specify ODE, output_name, with units that SimuPyProblem expects</span>
                    <span class="c1"># assume event function is of form ODE.output_name - value</span>
                    <span class="c1"># third key is event_idx associated with input</span>
                    <span class="p">(</span><span class="s1">&#39;groundroll&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">VELOCITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;climb3&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;cruise&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Vehicle</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">traj_intermediate_state_output</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;cruise&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;cruise&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Vehicle</span><span class="o">.</span><span class="n">MASS</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="s1">&#39;traj&#39;</span><span class="p">,</span>
                <span class="n">full_traj</span><span class="p">,</span>
                <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;altitude_initial&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">CRUISE_ALTITUDE</span><span class="p">)],</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="s1">&#39;actual_descent_fuel&#39;</span><span class="p">,</span>
                <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                    <span class="s1">&#39;actual_descent_fuel = traj_cruise_mass_final - traj_mass_final&#39;</span><span class="p">,</span>
                    <span class="n">actual_descent_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                    <span class="n">traj_cruise_mass_final</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                    <span class="n">traj_mass_final</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;start_of_descent_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;traj.SGMCruise_mass_trigger&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="s1">&#39;traj.mass_final&#39;</span><span class="p">,</span>
                <span class="s1">&#39;actual_descent_fuel.traj_mass_final&#39;</span><span class="p">,</span>
                <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">flat_src_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="s1">&#39;traj.cruise_mass_final&#39;</span><span class="p">,</span>
                <span class="s1">&#39;actual_descent_fuel.traj_cruise_mass_final&#39;</span><span class="p">,</span>
                <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">flat_src_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">full_traj</span>
            <span class="k">return</span> <span class="n">traj</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">add_subsystem_timeseries_outputs</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">):</span>
            <span class="n">phase_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
            <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span><span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
                <span class="n">timeseries_to_add</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">timeseries</span> <span class="ow">in</span> <span class="n">timeseries_to_add</span><span class="p">:</span>
                    <span class="n">phase</span><span class="o">.</span><span class="n">add_timeseries_output</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
                <span class="n">mbvars</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_post_mission_bus_variables</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">mbvars</span><span class="p">:</span>
                    <span class="n">mbvars_this_phase</span> <span class="o">=</span> <span class="n">mbvars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mbvars_this_phase</span><span class="p">:</span>
                        <span class="n">timeseries_to_add</span> <span class="o">=</span> <span class="n">mbvars_this_phase</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">timeseries</span> <span class="ow">in</span> <span class="n">timeseries_to_add</span><span class="p">:</span>
                            <span class="n">phase</span><span class="o">.</span><span class="n">add_timeseries_output</span><span class="p">(</span>
                                <span class="n">timeseries</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">=</span><span class="s1">&#39;mission_bus_variables&#39;</span>
                            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">phase_idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">add_phase</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phase</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_idx</span><span class="p">))</span>
                <span class="n">add_subsystem_timeseries_outputs</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>

        <span class="c1"># loop through phase_info and external subsystems</span>
        <span class="n">external_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">:</span>
            <span class="n">external_parameters</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">subsystem_options</span> <span class="o">=</span> <span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subsystem_options&#39;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">subsystem_options</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">subsystem_options</span><span class="p">[</span><span class="n">subsystem</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">parameter_dict</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span>
                    <span class="n">phase_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">],</span>
                    <span class="n">aviary_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameter_dict</span><span class="p">:</span>
                    <span class="n">external_parameters</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span>

        <span class="n">traj</span> <span class="o">=</span> <span class="n">setup_trajectory_params</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">traj</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span>
            <span class="n">phases</span><span class="p">,</span>
            <span class="n">meta_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">,</span>
            <span class="n">external_parameters</span><span class="o">=</span><span class="n">external_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">traj</span>

        <span class="k">return</span> <span class="n">traj</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_phase_mission_bus_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phase_mission_bus_lengths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">_phases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">phase_mission_bus_lengths</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">_timeseries</span><span class="p">[</span><span class="s1">&#39;mission_bus_variables&#39;</span><span class="p">][</span>
                <span class="s1">&#39;transcription&#39;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">subset_num_nodes</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">phase_mission_bus_lengths</span>

<div class="viewcode-block" id="AviaryProblem.add_post_mission_systems">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_post_mission_systems">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_post_mission_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_landing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add post-mission systems to the aircraft model. This is akin to the pre-mission</span>
<span class="sd">        group or the &quot;premission_systems&quot;, but occurs after the mission in the execution</span>
<span class="sd">        order.</span>

<span class="sd">        Depending on the mission model specified (`FLOPS` or `GASP`), this method adds</span>
<span class="sd">        various subsystems to the aircraft model. For the `FLOPS` mission model, a</span>
<span class="sd">        landing phase is added using the Landing class with the wing area and lift</span>
<span class="sd">        coefficient specified, and a takeoff constraints ExecComp is added to enforce</span>
<span class="sd">        mass, range, velocity, and altitude continuity between the takeoff and climb</span>
<span class="sd">        phases. The landing subsystem is promoted with aircraft and mission inputs and</span>
<span class="sd">        outputs as appropriate, while the takeoff constraints ExecComp is only promoted</span>
<span class="sd">        with mission inputs and outputs.</span>

<span class="sd">        For the `GASP` mission model, four subsystems are added: a LandingSegment</span>
<span class="sd">        subsystem, an ExecComp to calculate the reserve fuel required, an ExecComp to</span>
<span class="sd">        calculate the overall fuel burn, and three ExecComps to calculate various</span>
<span class="sd">        mission objectives and constraints. All subsystems are promoted with aircraft</span>
<span class="sd">        and mission inputs and outputs as appropriate.</span>

<span class="sd">        A user can override this with their own postmission systems.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;post_mission&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="p">,</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">add_post_mission_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_landing</span><span class="p">)</span>

        <span class="c1"># Add all post-mission external subsystems.</span>
        <span class="n">phase_mission_bus_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phase_mission_bus_lengths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]:</span>
            <span class="n">subsystem_postmission</span> <span class="o">=</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">build_post_mission</span><span class="p">(</span>
                <span class="n">aviary_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span>
                <span class="n">phase_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span>
                <span class="n">phase_mission_bus_lengths</span><span class="o">=</span><span class="n">phase_mission_bus_lengths</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">subsystem_postmission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">subsystem_postmission</span><span class="p">)</span>

        <span class="c1"># Check if regular_phases[] is accessible</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;regular_phases[] dictionary is not accessible. For HEIGHT_ENERGY and &#39;</span>
                <span class="s1">&#39;SOLVED_2DOF missions, check_and_preprocess_inputs() must be called &#39;</span>
                <span class="s1">&#39;before add_post_mission_systems().&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Fuel burn in regular phases</span>
        <span class="n">ecomp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
            <span class="s1">&#39;fuel_burned = initial_mass - mass_final&#39;</span><span class="p">,</span>
            <span class="n">initial_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">mass_final</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">fuel_burned</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span>
            <span class="n">ecomp</span><span class="p">,</span>
            <span class="n">promotes</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">FUEL_BURNED</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
            <span class="c1"># shooting method currently doesn&#39;t have timeseries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span>
                <span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;mass_final&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;include_takeoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span>
                    <span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span>
                    <span class="p">[(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">)],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># timeseries has to be used because Breguet cruise phases don&#39;t have</span>
                <span class="c1"># states</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.timeseries.mass&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;fuel_burned.initial_mass&#39;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">.timeseries.mass&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fuel_burned.mass_final&#39;</span><span class="p">,</span>
                <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Fuel burn in reserve phases</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">:</span>
            <span class="n">ecomp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="s1">&#39;reserve_fuel_burned = initial_mass - mass_final&#39;</span><span class="p">,</span>
                <span class="n">initial_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                <span class="n">mass_final</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                <span class="n">reserve_fuel_burned</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="s1">&#39;reserve_fuel_burned&#39;</span><span class="p">,</span>
                <span class="n">ecomp</span><span class="p">,</span>
                <span class="n">promotes</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;reserve_fuel_burned&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RESERVE_FUEL_BURNED</span><span class="p">)],</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
                <span class="c1"># shooting method currently doesn&#39;t have timeseries</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span>
                    <span class="s1">&#39;reserve_fuel_burned&#39;</span><span class="p">,</span>
                    <span class="p">[(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">)],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">.states:mass&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;reserve_fuel_burned.mass_final&#39;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># timeseries has to be used because Breguet cruise phases don&#39;t have</span>
                <span class="c1"># states</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.timeseries.mass&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;reserve_fuel_burned.initial_mass&#39;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">.timeseries.mass&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;reserve_fuel_burned.mass_final&#39;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_fuel_reserve_component</span><span class="p">()</span>

        <span class="c1"># TODO: need to add some sort of check that this value is less than the fuel capacity</span>
        <span class="c1"># TODO: the overall_fuel variable is the burned fuel plus the reserve, but should</span>
        <span class="c1"># also include the unused fuel, and the hierarchy variable name should be</span>
        <span class="c1"># more clear</span>
        <span class="n">ecomp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
            <span class="s1">&#39;overall_fuel = (1 + fuel_margin/100)*fuel_burned + reserve_fuel&#39;</span><span class="p">,</span>
            <span class="n">overall_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="n">fuel_margin</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;unitless&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="n">fuel_burned</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>  <span class="c1"># from regular_phases only</span>
            <span class="n">reserve_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;fuel_calc&#39;</span><span class="p">,</span>
            <span class="n">ecomp</span><span class="p">,</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;fuel_margin&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Fuel</span><span class="o">.</span><span class="n">FUEL_MARGIN</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">FUEL_BURNED</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;reserve_fuel&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;overall_fuel&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">TOTAL_FUEL_MASS</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="c1"># If a target distance (or time) has been specified for this phase</span>
        <span class="c1"># distance (or time) is measured from the start of this phase to the end</span>
        <span class="c1"># of this phase</span>
        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;target_distance&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]:</span>
                <span class="n">target_distance</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;target_distance&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;nmi&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_distance_constraint&#39;</span><span class="p">,</span>
                    <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                        <span class="s1">&#39;distance_resid = target_distance - (final_distance - initial_distance)&#39;</span><span class="p">,</span>
                        <span class="n">distance_resid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                        <span class="n">target_distance</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">target_distance</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                        <span class="n">final_distance</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                        <span class="n">initial_distance</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.timeseries.distance&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_distance_constraint.final_distance&#39;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.timeseries.distance&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_distance_constraint.initial_distance&#39;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_distance_constraint.distance_resid&#39;</span><span class="p">,</span>
                    <span class="n">equals</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># this is only used for analytic phases with a target duration</span>
            <span class="k">if</span> <span class="s1">&#39;target_duration&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span>
                <span class="n">phase_name</span>
            <span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;analytic&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">target_duration</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;target_duration&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;min&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_duration_constraint&#39;</span><span class="p">,</span>
                    <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                        <span class="s1">&#39;duration_resid = target_duration - (final_time - initial_time)&#39;</span><span class="p">,</span>
                        <span class="n">duration_resid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">},</span>
                        <span class="n">target_duration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">target_duration</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">},</span>
                        <span class="n">final_time</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">},</span>
                        <span class="n">initial_time</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">},</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.timeseries.time&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_duration_constraint.final_time&#39;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.timeseries.time&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_duration_constraint.initial_time&#39;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_duration_constraint.duration_resid&#39;</span><span class="p">,</span>
                    <span class="n">equals</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ecomp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
            <span class="s1">&#39;mass_resid = operating_empty_mass + overall_fuel + payload_mass - initial_mass&#39;</span><span class="p">,</span>
            <span class="n">operating_empty_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">overall_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">payload_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">initial_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">mass_resid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">payload_mass_src</span> <span class="o">=</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">TOTAL_PAYLOAD_MASS</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;mass_constraint&#39;</span><span class="p">,</span>
            <span class="n">ecomp</span><span class="p">,</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;operating_empty_mass&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">OPERATING_MASS</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;overall_fuel&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">TOTAL_FUEL_MASS</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;payload_mass&#39;</span><span class="p">,</span> <span class="n">payload_mass_src</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;mass_resid&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">MASS_RESIDUAL</span><span class="p">)],</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_link_phases_helper_with_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Initialize a list to keep track of indices where option_name is True</span>
        <span class="n">true_option_indices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop through phases to find where option_name is True</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">true_option_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># Determine the groups of phases to link based on consecutive indices</span>
        <span class="n">groups_to_link</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_group</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">true_option_indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_group</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">current_group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If the current index is consecutive, add it to the current group</span>
                <span class="n">current_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, start a new group and save the previous one</span>
                <span class="n">groups_to_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_group</span><span class="p">)</span>
                <span class="n">current_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Add the last group if it exists</span>
        <span class="k">if</span> <span class="n">current_group</span><span class="p">:</span>
            <span class="n">groups_to_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_group</span><span class="p">)</span>

        <span class="c1"># Loop through each group and determine the phases to link</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups_to_link</span><span class="p">:</span>
            <span class="c1"># Extend the group to include the phase before the first True option and</span>
            <span class="c1"># after the last True option, if applicable</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Extract the phase names for the current group</span>
            <span class="n">phases_to_link</span> <span class="o">=</span> <span class="p">[</span><span class="n">phases</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span>

            <span class="c1"># Link the phases for the current group</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases_to_link</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="o">=</span><span class="n">phases_to_link</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="AviaryProblem.link_phases">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.link_phases">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">link_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Link phases together after they&#39;ve been added.</span>

<span class="sd">        Based on which phases the user has selected, we might need</span>
<span class="sd">        special logic to do the Dymos linkages correctly. Some of those</span>
<span class="sd">        connections for the simple GASP and FLOPS mission are shown here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_bus_variables_and_connect</span><span class="p">()</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># In summary, the following code loops over all phases in self.phase_info, gets</span>
        <span class="c1"># the linked variables from each external subsystem in each phase, and stores</span>
        <span class="c1"># the lists of linked variables in lists_to_link. It then gets a list of</span>
        <span class="c1"># unique variable names from lists_to_link and loops over them, creating</span>
        <span class="c1"># a list of phase names for each variable and linking the phases</span>
        <span class="c1"># using self.traj.link_phases().</span>

        <span class="n">lists_to_link</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
            <span class="n">lists_to_link</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]:</span>
                <span class="n">lists_to_link</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">get_linked_variables</span><span class="p">())</span>

        <span class="c1"># get unique variable names from lists_to_link</span>
        <span class="n">unique_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">var</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">lists_to_link</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]))</span>

        <span class="c1"># Phase linking.</span>
        <span class="c1"># If we are under mpi, and traj.phases is running in parallel, then let the</span>
        <span class="c1"># optimizer handle the linkage constraints.  Note that we can technically</span>
        <span class="c1"># parallelize connected phases, but it requires a solver that we would like</span>
        <span class="c1"># to avoid.</span>
        <span class="n">true_unless_mpi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;parallel_phases&#39;</span><span class="p">]:</span>
            <span class="n">true_unless_mpi</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># loop over unique variable names</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">unique_vars</span><span class="p">:</span>
            <span class="n">phases_to_link</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">lists_to_link</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                    <span class="n">phases_to_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases_to_link</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># TODO: hack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="o">=</span><span class="n">phases_to_link</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">connect_directly</span><span class="o">=</span><span class="n">true_unless_mpi</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_mission_bus_variables</span><span class="p">()</span></div>


<div class="viewcode-block" id="AviaryProblem.add_driver">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_driver">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_coloring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an optimization driver to the Aviary problem.</span>

<span class="sd">        Depending on the provided optimizer, the method instantiates the relevant</span>
<span class="sd">        driver (ScipyOptimizeDriver or pyOptSparseDriver) and sets the optimizer</span>
<span class="sd">        options. Options for &#39;SNOPT&#39;, &#39;IPOPT&#39;, and &#39;SLSQP&#39; are specified. The method</span>
<span class="sd">        also allows for the declaration of coloring and setting debug print options.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        optimizer : str</span>
<span class="sd">            The name of the optimizer to use. It can be &quot;SLSQP&quot;, &quot;SNOPT&quot;, &quot;IPOPT&quot; or</span>
<span class="sd">            others supported by OpenMDAO. If &quot;SLSQP&quot;, it will instantiate a</span>
<span class="sd">            ScipyOptimizeDriver, else it will instantiate a pyOptSparseDriver.</span>

<span class="sd">        use_coloring : bool, optional</span>
<span class="sd">            If True (default), the driver will declare coloring, which can speed up</span>
<span class="sd">            derivative computations.</span>

<span class="sd">        max_iter : int, optional</span>
<span class="sd">            The maximum number of iterations allowed for the optimization process.</span>
<span class="sd">            Default is 50. This option is applicable to &quot;SNOPT&quot;, &quot;IPOPT&quot;, and &quot;SLSQP&quot;</span>
<span class="sd">            optimizers.</span>

<span class="sd">        verbosity : Verbosity or int, optional</span>
<span class="sd">            Controls the level of printouts for this method. If None, uses the value of</span>
<span class="sd">            Settings.VERBOSITY in provided aircraft data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="c1"># Set defaults for optimizer and use_coloring based on analysis scheme</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;IPOPT&#39;</span>
        <span class="k">if</span> <span class="n">use_coloring</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_coloring</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span> <span class="k">else</span> <span class="kc">True</span>

        <span class="c1"># check if optimizer is SLSQP</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;SLSQP&#39;</span><span class="p">:</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ScipyOptimizeDriver</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">pyOptSparseDriver</span><span class="p">()</span>

        <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="k">if</span> <span class="n">use_coloring</span><span class="p">:</span>
            <span class="c1"># define coloring options by verbosity</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>  <span class="c1"># QUIET, BRIEF</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="n">show_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="n">show_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># DEBUG</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="n">show_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_sparsity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SNOPT&#39;</span><span class="p">:</span>
            <span class="c1"># Print Options #</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="n">isumm</span><span class="p">,</span> <span class="n">iprint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>
                <span class="n">isumm</span><span class="p">,</span> <span class="n">iprint</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                <span class="n">isumm</span><span class="p">,</span> <span class="n">iprint</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;iSumm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isumm</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;iPrint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iprint</span>
            <span class="c1"># Optimizer Settings #</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;Major iterations limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iter</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;Major optimality tolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;Major feasibility tolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-7</span>

        <span class="k">elif</span> <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IPOPT&#39;</span><span class="p">:</span>
            <span class="c1"># Print Options #</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="n">print_level</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;print_user_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>
                <span class="n">print_level</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># minimum to get exit status</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;print_user_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;print_frequency_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">print_level</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># DEBUG</span>
                <span class="n">print_level</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">print_level</span>
            <span class="c1"># Optimizer Settings #</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;mu_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iter</span>
            <span class="c1"># for faster convergence</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;nlp_scaling_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gradient-based&#39;</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;alpha_for_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;safer-min-dual-infeas&#39;</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;monotone&#39;</span>

        <span class="k">elif</span> <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SLSQP&#39;</span><span class="p">:</span>
            <span class="c1"># Print Options #</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disp</span>
            <span class="c1"># Optimizer Settings #</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iter</span>

        <span class="c1"># pyoptsparse print settings for both SNOPT, IPOPT</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SNOPT&#39;</span><span class="p">,</span> <span class="s1">&#39;IPOPT&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">&lt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>  <span class="c1"># QUIET, BRIEF, VERBOSE</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;minimal&#39;</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_opt_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># optimizer agnostic settings</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;debug_print&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;desvars&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;debug_print&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;desvars&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ln_cons&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nl_cons&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;objs&#39;</span><span class="p">,</span>
                <span class="p">]</span></div>


<div class="viewcode-block" id="AviaryProblem.add_design_variables">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_design_variables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_design_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds design variables to the Aviary problem.</span>

<span class="sd">        Depending on the mission model and problem type, different design variables and</span>
<span class="sd">        constraints are added.</span>

<span class="sd">        If using the FLOPS model, a design variable is added for the gross mass of the</span>
<span class="sd">        aircraft, with a lower bound of 10 lbm and an upper bound of 900,000 lbm.</span>

<span class="sd">        If using the GASP model, the following design variables are added depending on</span>
<span class="sd">        the mission type:</span>
<span class="sd">        - the initial thrust-to-weight ratio of the aircraft during ascent</span>
<span class="sd">        - the duration of the ascent phase</span>
<span class="sd">        - the time constant for the landing gear actuation</span>
<span class="sd">        - the time constant for the flaps actuation</span>

<span class="sd">        In addition, two constraints are added for the GASP model:</span>
<span class="sd">        - the initial altitude of the aircraft with gear extended is constrained to be 50 ft</span>
<span class="sd">        - the initial altitude of the aircraft with flaps extended is constrained to be 400 ft</span>

<span class="sd">        If solving a sizing problem, a design variable is added for the gross mass of</span>
<span class="sd">        the aircraft, and another for the gross mass of the aircraft computed during the</span>
<span class="sd">        mission. A constraint is also added to ensure that the residual range is zero.</span>

<span class="sd">        If solving an alternate problem, only a design variable for the gross mass of</span>
<span class="sd">        the aircraft computed during the mission is added. A constraint is also added to</span>
<span class="sd">        ensure that the residual range is zero.</span>

<span class="sd">        In all cases, a design variable is added for the final cruise mass of the</span>
<span class="sd">        aircraft, with no upper bound, and a residual mass constraint is added to ensure</span>
<span class="sd">        that the mass balances.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="c1"># add the engine builder `get_design_vars` dict to a collected dict from</span>
        <span class="c1"># the external subsystems</span>

        <span class="c1"># TODO : maybe in the most general case we need to handle DVs in the mission and</span>
        <span class="c1"># post-mission as well. For right now we just handle pre_mission</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">()</span>

        <span class="c1"># loop through all_subsystems and call `get_design_vars` on each subsystem</span>
        <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="n">dv_dict</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_design_vars</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dv_name</span><span class="p">,</span> <span class="n">dv_dict</span> <span class="ow">in</span> <span class="n">dv_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="n">dv_name</span><span class="p">,</span> <span class="o">**</span><span class="n">dv_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
            <span class="n">optimize_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimize_mass&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">optimize_mass</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mf">900.0e3</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mf">175.0e3</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">):</span>
            <span class="c1"># vehicle sizing problem</span>
            <span class="c1"># size the vehicle (via design GTOW) to meet a target range using all fuel</span>
            <span class="c1"># capacity</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">SIZING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mf">175e3</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mf">175e3</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                    <span class="s1">&#39;gtow_constraint&#39;</span><span class="p">,</span>
                    <span class="n">om</span><span class="o">.</span><span class="n">EQConstraintComp</span><span class="p">(</span>
                        <span class="s1">&#39;GTOW&#39;</span><span class="p">,</span>
                        <span class="n">eq_units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">,</span>
                        <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">add_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;lhs:GTOW&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;rhs:GTOW&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_range_residual</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">RANGE_RESIDUAL</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># target range problem</span>
            <span class="c1"># fixed vehicle (design GTOW) but variable actual GTOW for off-design</span>
            <span class="c1"># mission range</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">ALTERNATE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mf">900e3</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mf">175e3</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">RANGE_RESIDUAL</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">FALLOUT</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No design variables for Fallout missions&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">MULTI_MISSION</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mf">900e3</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mf">175e3</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">RANGE_RESIDUAL</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

                <span class="c1"># We must ensure that design.gross_mass is greater than</span>
                <span class="c1"># mission.summary.gross_mass and this must hold true for each of the</span>
                <span class="c1"># different missions that is flown the result will be the</span>
                <span class="c1"># design.gross_mass should be equal to the mission.summary.gross_mass</span>
                <span class="c1"># of the heaviest mission</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                    <span class="s1">&#39;GROSS_MASS_constraint&#39;</span><span class="p">,</span>
                    <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                        <span class="s1">&#39;gross_mass_resid = design_mass - actual_mass&#39;</span><span class="p">,</span>
                        <span class="n">design_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg&#39;</span><span class="p">},</span>
                        <span class="n">actual_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg&#39;</span><span class="p">},</span>
                        <span class="n">gross_mass_resid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg&#39;</span><span class="p">},</span>
                    <span class="p">),</span>
                    <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;design_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;actual_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                    <span class="p">],</span>
                    <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gross_mass_resid&#39;</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;gross_mass_resid&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span>
            <span class="p">):</span>
                <span class="c1"># problem formulation to make the trajectory work</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_T_INITIAL</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">30.0</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_DURATION</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">10.0</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="s1">&#39;tau_gear&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="s1">&#39;tau_flaps&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;h_fit.h_init_gear&#39;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">50.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;h_fit.h_init_flaps&#39;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">400.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">400.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="AviaryProblem.add_objective">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_objective">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the objective function based on the given objective_type and ref.</span>

<span class="sd">        NOTE: the ref value should be positive for values you&#39;re trying</span>
<span class="sd">        to minimize and negative for values you&#39;re trying to maximize.</span>
<span class="sd">        Please check and double-check that your ref value makes sense</span>
<span class="sd">        for the objective you&#39;re using.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objective_type : str</span>
<span class="sd">            The type of objective to add. Options are &#39;mass&#39;, &#39;hybrid_objective&#39;,</span>
<span class="sd">            &#39;fuel_burned&#39;, and &#39;fuel&#39;.</span>
<span class="sd">        ref : float</span>
<span class="sd">            The reference value for the objective. If None, a default value will be used</span>
<span class="sd">            based on the objective type. Please see the `default_ref_values` dict for</span>
<span class="sd">            these default values.</span>
<span class="sd">        verbosity : Verbosity or int, optional</span>
<span class="sd">            Controls the level of printouts for this method. If None, uses the value of</span>
<span class="sd">            Settings.VERBOSITY in provided aircraft data.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">            ValueError: If an invalid problem type is provided.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;fuel_obj&#39;</span><span class="p">,</span>
            <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="s1">&#39;reg_objective = overall_fuel/10000 + ascent_duration/30.&#39;</span><span class="p">,</span>
                <span class="n">reg_objective</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;unitless&#39;</span><span class="p">},</span>
                <span class="n">ascent_duration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="n">overall_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;ascent_duration&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_DURATION</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;overall_fuel&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">TOTAL_FUEL_MASS</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;reg_objective&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">FUEL</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;range_obj&#39;</span><span class="p">,</span>
            <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="s1">&#39;reg_objective = -actual_range/1000 + ascent_duration/30.&#39;</span><span class="p">,</span>
                <span class="n">reg_objective</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;unitless&#39;</span><span class="p">},</span>
                <span class="n">ascent_duration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="n">actual_range</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_range</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;NM&#39;</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;actual_range&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RANGE</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ascent_duration&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_DURATION</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;reg_objective&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">RANGE</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="c1"># Dictionary for default reference values</span>
        <span class="n">default_ref_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5e4</span><span class="p">,</span>
            <span class="s1">&#39;hybrid_objective&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5e4</span><span class="p">,</span>
            <span class="s1">&#39;fuel_burned&#39;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
            <span class="s1">&#39;fuel&#39;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Check if an objective type is specified</span>
        <span class="k">if</span> <span class="n">objective_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_ref_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">objective_type</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">final_phase_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s1">.timeseries.</span><span class="si">{</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Vehicle</span><span class="o">.</span><span class="n">MASS</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">_phases</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="n">final_phase_name</span><span class="p">]</span>
                    <span class="n">last_phase</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Vehicle</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s1">.timeseries.time&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s1">&#39;hybrid_objective&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_hybrid_objective</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="s1">&#39;obj_comp.obj&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s1">&#39;fuel_burned&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">FUEL_BURNED</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s1">&#39;fuel&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">FUEL</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objective_type</span><span class="si">}</span><span class="s2"> is not a valid objective. &#39;objective_type&#39; must &quot;</span>
                    <span class="s1">&#39;be one of the following: mass, time, hybrid_objective, &#39;</span>
                    <span class="s1">&#39;fuel_burned, or fuel&#39;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If no &#39;objective_type&#39; is specified, we handle based on &#39;problem_type&#39;</span>
            <span class="c1"># If &#39;ref&#39; is not specified, assign a default value</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">SIZING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">FUEL</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">ALTERNATE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">FUEL</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">FALLOUT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span><span class="si">}</span><span class="s1"> is not a valid problem type.&#39;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_add_bus_variables_and_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">()</span>

        <span class="n">base_phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="n">bus_variables</span> <span class="o">=</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">get_pre_mission_bus_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bus_variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bus_variable</span><span class="p">,</span> <span class="n">variable_data</span> <span class="ow">in</span> <span class="n">bus_variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">mission_variable_name</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[</span><span class="s1">&#39;mission_name&#39;</span><span class="p">]</span>

                    <span class="c1"># check if mission_variable_name is a list</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mission_variable_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">mission_variable_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">mission_variable_name</span><span class="p">]</span>

                    <span class="c1"># loop over the mission_variable_name list and add each variable to</span>
                    <span class="c1"># the trajectory</span>
                    <span class="k">for</span> <span class="n">mission_var_name</span> <span class="ow">in</span> <span class="n">mission_variable_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">mission_var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
                            <span class="c1"># base_units = self.model.get_io_metadata(includes=f&#39;pre_mission.{external_subsystem.name}.{bus_variable}&#39;)[f&#39;pre_mission.{external_subsystem.name}.{bus_variable}&#39;][&#39;units&#39;]</span>
                            <span class="n">base_units</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

                            <span class="n">shape</span> <span class="o">=</span> <span class="n">variable_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="n">_unspecified</span><span class="p">)</span>

                            <span class="n">targets</span> <span class="o">=</span> <span class="n">mission_var_name</span>
                            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">mission_var_name</span><span class="p">:</span>
                                <span class="c1"># Support for non-hierarchy variables as parameters.</span>
                                <span class="n">mission_var_name</span> <span class="o">=</span> <span class="n">mission_var_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                            <span class="k">if</span> <span class="s1">&#39;phases&#39;</span> <span class="ow">in</span> <span class="n">variable_data</span><span class="p">:</span>
                                <span class="c1"># Support for connecting bus variables into a subset of</span>
                                <span class="c1"># phases.</span>
                                <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">variable_data</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">]:</span>
                                    <span class="n">phase</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>

                                    <span class="n">phase</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
                                        <span class="n">mission_var_name</span><span class="p">,</span>
                                        <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">static_target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">units</span><span class="o">=</span><span class="n">base_units</span><span class="p">,</span>
                                        <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                                        <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
                                    <span class="p">)</span>

                                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s1">&#39;pre_mission.</span><span class="si">{</span><span class="n">bus_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.parameters:</span><span class="si">{</span><span class="n">mission_var_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span>
                                    <span class="n">mission_var_name</span><span class="p">,</span>
                                    <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">static_target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">units</span><span class="o">=</span><span class="n">base_units</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                                    <span class="n">targets</span><span class="o">=</span><span class="p">{</span>
                                        <span class="n">phase_name</span><span class="p">:</span> <span class="p">[</span><span class="n">mission_var_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">base_phases</span>
                                    <span class="p">},</span>
                                <span class="p">)</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s1">&#39;pre_mission.</span><span class="si">{</span><span class="n">bus_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;traj.parameters:&#39;</span> <span class="o">+</span> <span class="n">mission_var_name</span><span class="p">,</span>
                                <span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;post_mission_name&#39;</span> <span class="ow">in</span> <span class="n">variable_data</span><span class="p">:</span>
                        <span class="c1"># check if post_mission_variable_name is a list</span>
                        <span class="n">post_mission_variable_name</span> <span class="o">=</span> <span class="n">variable_data</span><span class="p">[</span><span class="s1">&#39;post_mission_name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">post_mission_variable_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">post_mission_variable_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">post_mission_variable_name</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">post_mission_var_name</span> <span class="ow">in</span> <span class="n">post_mission_variable_name</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;pre_mission.</span><span class="si">{</span><span class="n">bus_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">post_mission_var_name</span><span class="p">,</span>
                            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect_mission_bus_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">()</span>

        <span class="c1"># Loop through all external subsystems.</span>
        <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">var_mapping</span> <span class="ow">in</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">get_post_mission_bus_variables</span><span class="p">(</span>
                <span class="n">aviary_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span> <span class="n">phase_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span>
            <span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">mission_variable_name</span><span class="p">,</span> <span class="n">post_mission_variable_names</span> <span class="ow">in</span> <span class="n">var_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">post_mission_variable_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">post_mission_variable_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">post_mission_variable_names</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">post_mission_var_name</span> <span class="ow">in</span> <span class="n">post_mission_variable_names</span><span class="p">:</span>
                        <span class="c1"># Remove possible prefix before a `.`, like &lt;external_subsystem_name&gt;.&lt;var_name&gt;&quot;</span>
                        <span class="n">mvn_basename</span> <span class="o">=</span> <span class="n">mission_variable_name</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">src_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.mission_bus_variables.</span><span class="si">{</span><span class="n">mvn_basename</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="n">post_mission_var_name</span><span class="p">)</span>

<div class="viewcode-block" id="AviaryProblem.setup">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lightly wrapped setup() method for the problem.&quot;&quot;&quot;</span>
        <span class="c1"># verbosity is not used in this method, but it is understandable that a user</span>
        <span class="c1"># might try and include it (only method that doesn&#39;t accept it). Capture it</span>
        <span class="k">if</span> <span class="s1">&#39;verbosity&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbosity&#39;</span><span class="p">)</span>
        <span class="c1"># Use OpenMDAO&#39;s model options to pass all options through the system hierarchy.</span>
        <span class="n">setup_model_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">)</span>

        <span class="c1"># suppress warnings:</span>
        <span class="c1"># &quot;input variable &#39;...&#39; promoted using &#39;*&#39; was already promoted using &#39;aircraft:*&#39;</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;aviary_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;aviary_metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;phase_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">OpenMDAOWarning</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">PromotionWarning</span><span class="p">)</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="AviaryProblem.set_initial_guesses">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.set_initial_guesses">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_initial_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_prob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call `set_val` on the trajectory for states and controls to seed</span>
<span class="sd">        the problem with reasonable initial guesses. This is especially</span>
<span class="sd">        important for collocation methods.</span>
<span class="sd">        This method first identifies all phases in the trajectory then</span>
<span class="sd">        loops over each phase. Specific initial guesses</span>
<span class="sd">        are added depending on the phase and mission method. Cruise is treated</span>
<span class="sd">        as a special phase for GASP-based missions because it is an AnalyticPhase</span>
<span class="sd">        in Dymos. For this phase, we handle the initial guesses first separately</span>
<span class="sd">        and continue to the next phase after that. For other phases, we set the initial</span>
<span class="sd">        guesses for states and controls according to the information available</span>
<span class="sd">        in the &#39;initial_guesses&#39; attribute of the phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="n">target_prob</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">parent_prob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parent_prefix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">target_prob</span> <span class="o">=</span> <span class="n">parent_prob</span>

        <span class="c1"># Grab the trajectory object from the model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">SIZING</span><span class="p">:</span>
                <span class="n">target_prob</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span>
                    <span class="n">parent_prefix</span> <span class="o">+</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="n">target_prob</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span>
                <span class="n">parent_prefix</span> <span class="o">+</span> <span class="s1">&#39;traj.SGMClimb_&#39;</span> <span class="o">+</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span> <span class="o">+</span> <span class="s1">&#39;_trigger&#39;</span><span class="p">,</span>
                <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cruise_alt</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="s1">&#39;ft&#39;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">return</span>

        <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">traj</span>

        <span class="c1"># Determine which phases to loop over, fetching them from the trajectory</span>
        <span class="n">phase_items</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">_phases</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="c1"># Loop over each phase and set initial guesses for the state and control</span>
        <span class="c1"># variables</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phase_items</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">apply_initial_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;traj&#39;</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;ground_roll&#39;</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;fix_initial&#39;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

            <span class="c1"># If not, fetch the initial guesses specific to the phase</span>
            <span class="c1"># check if guesses exist for this phase</span>
            <span class="k">if</span> <span class="s1">&#39;initial_guesses&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="n">guesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;initial_guesses&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guesses</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Add subsystem guesses</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_subsystem_guesses</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">target_prob</span><span class="p">,</span> <span class="n">parent_prefix</span><span class="p">)</span>

            <span class="c1"># Set initial guesses for states and controls for each phase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">add_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">guesses</span><span class="p">,</span> <span class="n">target_prob</span><span class="p">,</span> <span class="n">parent_prefix</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_process_guess_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the guess variable, which can either be a float or an array of floats.</span>
<span class="sd">        This method is responsible for interpolating initial guesses when the user</span>
<span class="sd">        provides a list or array of values rather than a single float. It interpolates</span>
<span class="sd">        the guess values across the phase&#39;s domain for a given variable, be it a control</span>
<span class="sd">        or a state variable. The interpolation is performed between -1 and 1 (representing</span>
<span class="sd">        the normalized phase time domain), using the numpy linspace function.</span>
<span class="sd">        The result of this method is a single value or an array of interpolated values</span>
<span class="sd">        that can be used to seed the optimization problem with initial guesses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        val : float or list/array of floats</span>
<span class="sd">            The initial guess value(s) for a particular variable.</span>
<span class="sd">        key : str</span>
<span class="sd">            The key identifying the variable for which the initial guess is provided.</span>
<span class="sd">        phase : Phase</span>
<span class="sd">            The phase for which the variable is being set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        val : float or array of floats</span>
<span class="sd">            The processed guess value(s) to be used in the optimization problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if val is not a single float</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="c1"># If val is an array of values</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Get the shape of the val array</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                <span class="c1"># Generate an array of evenly spaced values between -1 and 1,</span>
                <span class="c1"># reshaping to match the shape of the val array</span>
                <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

                <span class="c1"># Check if the key indicates a control or state variable</span>
                <span class="k">if</span> <span class="s1">&#39;controls:&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;states:&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="c1"># If so, strip the first part of the key to match the variable name</span>
                    <span class="c1"># in phase</span>
                    <span class="n">stripped_key</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

                    <span class="c1"># Interpolate the initial guess values across the phase&#39;s domain</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">stripped_key</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If not a control or state variable, interpolate the initial guess</span>
                    <span class="c1"># values directly</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>

        <span class="c1"># Return the processed guess value(s)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_subsystem_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">target_prob</span><span class="p">,</span> <span class="n">parent_prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the initial guesses for each subsystem of a given phase to the problem.</span>
<span class="sd">        This method first fetches all subsystems associated with the given phase.</span>
<span class="sd">        It then loops over each subsystem and fetches its initial guesses. For each</span>
<span class="sd">        guess, it identifies whether the guess corresponds to a state or a control</span>
<span class="sd">        variable and then processes the guess variable. After this, the initial</span>
<span class="sd">        guess is set in the problem using the `set_val` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase_name : str</span>
<span class="sd">            The name of the phase for which the subsystem guesses are being added.</span>
<span class="sd">        phase : Phase</span>
<span class="sd">            The phase object for which the subsystem guesses are being added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all subsystems associated with the phase</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Loop over each subsystem</span>
        <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="c1"># Fetch the initial guesses for the subsystem</span>
            <span class="n">initial_guesses</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_initial_guesses</span><span class="p">()</span>

            <span class="c1"># Loop over each guess</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">initial_guesses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Identify the type of the guess (state or control)</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;state&#39;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">:</span>
                    <span class="n">path_string</span> <span class="o">=</span> <span class="s1">&#39;states&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;control&#39;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">:</span>
                    <span class="n">path_string</span> <span class="o">=</span> <span class="s1">&#39;controls&#39;</span>

                <span class="c1"># Process the guess variable (handles array interpolation)</span>
                <span class="n">val</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_guess_var</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

                <span class="c1"># Set the initial guess in the problem</span>
                <span class="n">target_prob</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">parent_prefix</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">path_string</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">val</span><span class="p">)</span>

<div class="viewcode-block" id="AviaryProblem.run_aviary_problem">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.run_aviary_problem">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_aviary_problem</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">record_filename</span><span class="o">=</span><span class="s1">&#39;problem_history.db&#39;</span><span class="p">,</span>
        <span class="n">optimization_history_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">restart_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">suppress_solver_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">run_driver</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">simulate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function actually runs the Aviary problem, which could be a simulation,</span>
<span class="sd">        optimization, or a driver execution, depending on the arguments provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        record_filename : str, optional</span>
<span class="sd">            The name of the database file where the solutions are to be recorded. The</span>
<span class="sd">            default is &quot;problem_history.db&quot;.</span>
<span class="sd">        optimization_history_filename : str, None</span>
<span class="sd">            The name of the database file where the driver iterations are to be</span>
<span class="sd">            recorded. The default is None.</span>
<span class="sd">        restart_filename : str, optional</span>
<span class="sd">            The name of the file that contains previously computed solutions which are</span>
<span class="sd">            to be used as starting points for this run. If it is None (default), no</span>
<span class="sd">            restart file will be used.</span>
<span class="sd">        suppress_solver_print : bool, optional</span>
<span class="sd">            If True (default), all solvers&#39; print statements will be suppressed. Useful</span>
<span class="sd">            for deeply nested models with multiple solvers so the print statements don&#39;t</span>
<span class="sd">            overwhelm the output.</span>
<span class="sd">        run_driver : bool, optional</span>
<span class="sd">            If True (default), the driver (aka optimizer) will be executed. If False,</span>
<span class="sd">            the problem will be run through one pass -- equivalent to OpenMDAO&#39;s</span>
<span class="sd">            `run_model` behavior.</span>
<span class="sd">        simulate : bool, optional</span>
<span class="sd">            If True, an explicit Dymos simulation will be performed. The default is</span>
<span class="sd">            False.</span>
<span class="sd">        make_plots : bool, optional</span>
<span class="sd">            If True (default), Dymos html plots will be generated as part of the output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_setup</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input_list.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_inputs</span><span class="p">(</span><span class="n">out_stream</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">suppress_solver_print</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_solver_print</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">optimization_history_filename</span><span class="p">:</span>
            <span class="n">recorder</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">SqliteRecorder</span><span class="p">(</span><span class="n">optimization_history_filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_recorder</span><span class="p">(</span><span class="n">recorder</span><span class="p">)</span>

        <span class="c1"># and run mission, and dynamics</span>
        <span class="k">if</span> <span class="n">run_driver</span><span class="p">:</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">run_problem</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">run_driver</span><span class="o">=</span><span class="n">run_driver</span><span class="p">,</span>
                <span class="n">simulate</span><span class="o">=</span><span class="n">simulate</span><span class="p">,</span>
                <span class="n">make_plots</span><span class="o">=</span><span class="n">make_plots</span><span class="p">,</span>
                <span class="n">solution_record_file</span><span class="o">=</span><span class="n">record_filename</span><span class="p">,</span>
                <span class="n">restart</span><span class="o">=</span><span class="n">restart_filename</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># TODO this is only used in a single test. Either self.problem_ran_successfully</span>
            <span class="c1">#      should be removed, or rework this option to be more helpful (store</span>
            <span class="c1"># entire &quot;failed&quot; object?) and implement more rigorously in benchmark</span>
            <span class="c1"># tests</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">problem_ran_successfully</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">failed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">failed</span><span class="o">.</span><span class="n">exit_status</span> <span class="o">==</span> <span class="s1">&#39;FAIL&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">problem_ran_successfully</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">problem_ran_successfully</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Manually print out a failure message for low verbosity modes that suppress</span>
            <span class="c1"># optimizer printouts, which may include the results message. Assumes success,</span>
            <span class="c1"># alerts user on a failure</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_ran_successfully</span> <span class="ow">and</span> <span class="n">verbosity</span> <span class="o">&lt;=</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span>  <span class="c1"># QUIET, BRIEF</span>
            <span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Aviary run failed. See the dashboard for more details.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># prevent UserWarning that is displayed when an event is triggered</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
            <span class="c1"># TODO failed doesn&#39;t exist for run_model(), no return from method</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>

        <span class="c1"># update n2 diagram after run.</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_reports_dir</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;n2.html&#39;</span><span class="p">)</span>
        <span class="n">om</span><span class="o">.</span><span class="n">n2</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span>
            <span class="n">show_browser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output_list.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">(</span><span class="n">out_stream</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">problem_ran_successfully</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">failed</span></div>


<div class="viewcode-block" id="AviaryProblem.alternate_mission">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.alternate_mission">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">alternate_mission</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run_mission</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">json_filename</span><span class="o">=</span><span class="s1">&#39;sizing_problem.json&#39;</span><span class="p">,</span>
        <span class="n">num_first</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_business</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_tourist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_pax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wing_cargo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">misc_cargo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cargo_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mission_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">phase_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function runs an alternate mission based on a sizing mission output.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        run_mission : bool</span>
<span class="sd">            Flag to determine whether to run the mission before returning the problem</span>
<span class="sd">            object.</span>
<span class="sd">        json_filename : str</span>
<span class="sd">            Name of the file that the sizing mission has been saved to.</span>
<span class="sd">        mission_range : float, optional</span>
<span class="sd">            Target range for the fallout mission.</span>
<span class="sd">        payload_mass : float, optional</span>
<span class="sd">            Mass of the payload for the mission.</span>
<span class="sd">        phase_info : dict, optional</span>
<span class="sd">            Dictionary containing the phases and their required parameters.</span>
<span class="sd">        verbosity : Verbosity or int, optional</span>
<span class="sd">            Controls the level of printouts for this method. If None, uses the value of</span>
<span class="sd">            Settings.VERBOSITY in provided aircraft data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="n">mass_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">MASS_METHOD</span><span class="p">)</span>
        <span class="n">equations_of_motion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">EQUATIONS_OF_MOTION</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mass_method</span> <span class="o">==</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">FLOPS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_first</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_business</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_tourist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;Incomplete PAX numbers for FLOPS fallout - assume same as design&#39;</span>
                    <span class="p">)</span>
                <span class="n">num_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">NUM_FIRST_CLASS</span><span class="p">)</span>
                <span class="n">num_business</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                    <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">NUM_BUSINESS_CLASS</span>
                <span class="p">)</span>
                <span class="n">num_tourist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                    <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">NUM_TOURIST_CLASS</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">wing_cargo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">misc_cargo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;Incomplete Cargo masses for FLOPS fallout - assume same as design&#39;</span>
                    <span class="p">)</span>
                <span class="n">wing_cargo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">WING_CARGO</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
                <span class="n">misc_cargo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">MISC_CARGO</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
            <span class="n">num_pax</span> <span class="o">=</span> <span class="n">cargo_mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">mass_method</span> <span class="o">==</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">GASP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_pax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unspecified PAX number for GASP fallout - assume same as design&#39;</span><span class="p">)</span>
                <span class="n">num_pax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">NUM_PASSENGERS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cargo_mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unspecified Cargo mass for GASP fallout - assume same as design&#39;</span><span class="p">)</span>
                <span class="n">cargo_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">CARGO_MASS</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
            <span class="n">num_first</span> <span class="o">=</span> <span class="n">num_business</span> <span class="o">=</span> <span class="n">num_tourist</span> <span class="o">=</span> <span class="n">wing_cargo</span> <span class="o">=</span> <span class="n">misc_cargo</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">phase_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span>
        <span class="k">if</span> <span class="n">mission_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># mission range is sliced from a column vector numpy array, i.e. it is a len</span>
            <span class="c1"># 1 numpy array</span>
            <span class="n">mission_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RANGE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># gross mass is sliced from a column vector numpy array, i.e. it is a len 1 numpy</span>
        <span class="c1"># array</span>
        <span class="n">mission_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span>

        <span class="n">prob_alternate</span> <span class="o">=</span> <span class="n">_load_off_design</span><span class="p">(</span>
            <span class="n">json_filename</span><span class="p">,</span>
            <span class="n">ProblemType</span><span class="o">.</span><span class="n">ALTERNATE</span><span class="p">,</span>
            <span class="n">equations_of_motion</span><span class="p">,</span>
            <span class="n">mass_method</span><span class="p">,</span>
            <span class="n">phase_info</span><span class="p">,</span>
            <span class="n">num_first</span><span class="p">,</span>
            <span class="n">num_business</span><span class="p">,</span>
            <span class="n">num_tourist</span><span class="p">,</span>
            <span class="n">num_pax</span><span class="p">,</span>
            <span class="n">wing_cargo</span><span class="p">,</span>
            <span class="n">misc_cargo</span><span class="p">,</span>
            <span class="n">cargo_mass</span><span class="p">,</span>
            <span class="n">mission_range</span><span class="p">,</span>
            <span class="n">mission_mass</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">check_and_preprocess_inputs</span><span class="p">()</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">add_pre_mission_systems</span><span class="p">()</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">add_phases</span><span class="p">()</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">add_post_mission_systems</span><span class="p">()</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">link_phases</span><span class="p">()</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">add_driver</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">add_design_variables</span><span class="p">()</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">add_objective</span><span class="p">()</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="n">prob_alternate</span><span class="o">.</span><span class="n">set_initial_guesses</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">run_mission</span><span class="p">:</span>
            <span class="n">prob_alternate</span><span class="o">.</span><span class="n">run_aviary_problem</span><span class="p">(</span><span class="n">record_filename</span><span class="o">=</span><span class="s1">&#39;alternate_problem_history.db&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prob_alternate</span></div>


<div class="viewcode-block" id="AviaryProblem.fallout_mission">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.fallout_mission">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fallout_mission</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run_mission</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">json_filename</span><span class="o">=</span><span class="s1">&#39;sizing_problem.json&#39;</span><span class="p">,</span>
        <span class="n">num_first</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_business</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_tourist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_pax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wing_cargo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">misc_cargo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cargo_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mission_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">phase_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function runs a fallout mission based on a sizing mission output.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        run_mission : bool</span>
<span class="sd">            Flag to determine whether to run the mission before returning the problem</span>
<span class="sd">            object.</span>
<span class="sd">        json_filename : str</span>
<span class="sd">            Name of the file that the sizing mission has been saved to.</span>
<span class="sd">        mission_mass : float, optional</span>
<span class="sd">            Takeoff mass for the fallout mission.</span>
<span class="sd">        payload_mass : float, optional</span>
<span class="sd">            Mass of the payload for the mission.</span>
<span class="sd">        phase_info : dict, optional</span>
<span class="sd">            Dictionary containing the phases and their required parameters.</span>
<span class="sd">        verbosity : Verbosity or int, optional</span>
<span class="sd">            Controls the level of printouts for this method. If None, uses the value of</span>
<span class="sd">            Settings.VERBOSITY in provided aircraft data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># `self.verbosity` is &quot;true&quot; verbosity for entire run. `verbosity` is verbosity</span>
        <span class="c1"># override for just this method</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compatibility with being passed int for verbosity</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">Verbosity</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>  <span class="c1"># defaults to BRIEF</span>

        <span class="n">mass_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">MASS_METHOD</span><span class="p">)</span>
        <span class="n">equations_of_motion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">EQUATIONS_OF_MOTION</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mass_method</span> <span class="o">==</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">FLOPS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_first</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_business</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_tourist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;Incomplete PAX numbers for FLOPS fallout - assume same as design&#39;</span>
                    <span class="p">)</span>
                <span class="n">num_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">NUM_FIRST_CLASS</span><span class="p">)</span>
                <span class="n">num_business</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                    <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">NUM_BUSINESS_CLASS</span>
                <span class="p">)</span>
                <span class="n">num_tourist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                    <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">NUM_TOURIST_CLASS</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">wing_cargo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">misc_cargo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;Incomplete Cargo masses for FLOPS fallout - assume same as design&#39;</span>
                    <span class="p">)</span>
                <span class="n">wing_cargo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">WING_CARGO</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
                <span class="n">misc_cargo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">MISC_CARGO</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
            <span class="n">num_pax</span> <span class="o">=</span> <span class="n">cargo_mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">mass_method</span> <span class="o">==</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">GASP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_pax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unspecified PAX number for GASP fallout - assume same as design&#39;</span><span class="p">)</span>
                <span class="n">num_pax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">NUM_PASSENGERS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cargo_mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unspecified Cargo mass for GASP fallout - assume same as design&#39;</span><span class="p">)</span>
                <span class="n">cargo_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">CARGO_MASS</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
            <span class="n">num_first</span> <span class="o">=</span> <span class="n">num_business</span> <span class="o">=</span> <span class="n">num_tourist</span> <span class="o">=</span> <span class="n">wing_cargo</span> <span class="o">=</span> <span class="n">misc_cargo</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">phase_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span>
        <span class="k">if</span> <span class="n">mission_mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># mission mass is sliced from a column vector numpy array, i.e. it is a len 1</span>
            <span class="c1"># numpy array</span>
            <span class="n">mission_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span>

        <span class="n">prob_fallout</span> <span class="o">=</span> <span class="n">_load_off_design</span><span class="p">(</span>
            <span class="n">json_filename</span><span class="p">,</span>
            <span class="n">ProblemType</span><span class="o">.</span><span class="n">FALLOUT</span><span class="p">,</span>
            <span class="n">equations_of_motion</span><span class="p">,</span>
            <span class="n">mass_method</span><span class="p">,</span>
            <span class="n">phase_info</span><span class="p">,</span>
            <span class="n">num_first</span><span class="p">,</span>
            <span class="n">num_business</span><span class="p">,</span>
            <span class="n">num_tourist</span><span class="p">,</span>
            <span class="n">num_pax</span><span class="p">,</span>
            <span class="n">wing_cargo</span><span class="p">,</span>
            <span class="n">misc_cargo</span><span class="p">,</span>
            <span class="n">cargo_mass</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">mission_mass</span><span class="p">,</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">check_and_preprocess_inputs</span><span class="p">()</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">add_pre_mission_systems</span><span class="p">()</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">add_phases</span><span class="p">()</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">add_post_mission_systems</span><span class="p">()</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">link_phases</span><span class="p">()</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">add_driver</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">add_design_variables</span><span class="p">()</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">add_objective</span><span class="p">()</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="n">prob_fallout</span><span class="o">.</span><span class="n">set_initial_guesses</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">run_mission</span><span class="p">:</span>
            <span class="n">prob_fallout</span><span class="o">.</span><span class="n">run_aviary_problem</span><span class="p">(</span><span class="n">record_filename</span><span class="o">=</span><span class="s1">&#39;fallout_problem_history.db&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prob_fallout</span></div>


<div class="viewcode-block" id="AviaryProblem.save_sizing_to_json">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.save_sizing_to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_sizing_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_filename</span><span class="o">=</span><span class="s1">&#39;sizing_problem.json&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function saves an aviary problem object into a json file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        aviary_problem : AviaryProblem</span>
<span class="sd">            Aviary problem object optimized for the aircraft design/sizing mission.</span>
<span class="sd">            Assumed to contain aviary_inputs and Mission.Summary.GROSS_MASS</span>
<span class="sd">        json_filename : string</span>
<span class="sd">            User specified name and relative path of json file to save the data into.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aviary_input_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonfile</span><span class="p">:</span>
            <span class="c1"># Loop through aviary input datastructure and create a list</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">:</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">type_value</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="c1"># Get the gross mass value from the sizing problem and add it to input</span>
                <span class="c1"># list</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">:</span>
                    <span class="n">Mission_Summary_GROSS_MASS_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                        <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span>
                    <span class="p">)</span>
                    <span class="n">Mission_Summary_GROSS_MASS_val_list</span> <span class="o">=</span> <span class="n">Mission_Summary_GROSS_MASS_val</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">Mission_Summary_GROSS_MASS_val_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># there are different data types we need to handle for conversion to</span>
                    <span class="c1"># json format</span>
                    <span class="c1"># int, bool, float doesn&#39;t need anything special</span>

                    <span class="c1"># Convert numpy arrays to lists</span>
                    <span class="k">if</span> <span class="n">type_value</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                    <span class="c1"># Lists are fine except if they contain enums or Paths</span>
                    <span class="k">if</span> <span class="n">type_value</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Enum</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Path</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
                                <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                    <span class="c1"># Enums and Paths need converting to a string</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Enum</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="c1"># Append the data to the list</span>
                <span class="n">aviary_input_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">type_value</span><span class="p">)])</span>

            <span class="c1"># Write the list to a json file</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="n">aviary_input_list</span><span class="p">,</span>
                <span class="n">jsonfile</span><span class="p">,</span>
                <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">jsonfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_add_hybrid_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_info</span><span class="p">):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">takeoff_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>

        <span class="n">obj_comp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;obj = -final_mass / </span><span class="si">{</span><span class="n">takeoff_mass</span><span class="si">}</span><span class="s1"> + final_time / 5.&#39;</span><span class="p">,</span>
            <span class="n">final_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">final_time</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;h&#39;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;obj_comp&#39;</span><span class="p">,</span> <span class="n">obj_comp</span><span class="p">)</span>

        <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s1">.timeseries.mass&#39;</span><span class="p">,</span>
            <span class="s1">&#39;obj_comp.final_mass&#39;</span><span class="p">,</span>
            <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s1">.timeseries.time&#39;</span><span class="p">,</span>
            <span class="s1">&#39;obj_comp.final_time&#39;</span><span class="p">,</span>
            <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_to_csv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value_units</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">):</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">value_units</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_all_subsystems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_subsystems</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">external_subsystems</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_subsystems</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_subsystems</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">external_subsystems</span><span class="p">)</span>

        <span class="n">all_subsystems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span><span class="p">[</span><span class="s1">&#39;aerodynamics&#39;</span><span class="p">])</span>
        <span class="n">all_subsystems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span><span class="p">[</span><span class="s1">&#39;propulsion&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">all_subsystems</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_fuel_reserve_component</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">post_mission</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reserves_name</span><span class="o">=</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">post_mission</span><span class="p">:</span>
            <span class="n">reserve_calc_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reserve_calc_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="n">RESERVE_FUEL_FRACTION</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL_FRACTION</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">RESERVE_FUEL_FRACTION</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">reserve_fuel_frac</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="s1">&#39;reserve_fuel_frac_mass = reserve_fuel_fraction * (takeoff_mass - final_mass)&#39;</span><span class="p">,</span>
                <span class="n">reserve_fuel_frac_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                <span class="n">reserve_fuel_fraction</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;unitless&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">RESERVE_FUEL_FRACTION</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">final_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                <span class="n">takeoff_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="n">reserve_calc_location</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="s1">&#39;reserve_fuel_frac&#39;</span><span class="p">,</span>
                <span class="n">reserve_fuel_frac</span><span class="p">,</span>
                <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;takeoff_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;final_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;reserve_fuel_fraction&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL_FRACTION</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reserve_fuel_frac_mass&#39;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">RESERVE_FUEL_ADDITIONAL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL_ADDITIONAL</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span>
        <span class="p">)</span>
        <span class="n">reserve_fuel</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
            <span class="s1">&#39;reserve_fuel = reserve_fuel_frac_mass + reserve_fuel_additional + reserve_fuel_burned&#39;</span><span class="p">,</span>
            <span class="n">reserve_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="n">reserve_fuel_frac_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="n">reserve_fuel_additional</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">RESERVE_FUEL_ADDITIONAL</span><span class="p">},</span>
            <span class="n">reserve_fuel_burned</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">reserve_calc_location</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;reserve_fuel&#39;</span><span class="p">,</span>
            <span class="n">reserve_fuel</span><span class="p">,</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;reserve_fuel_frac_mass&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;reserve_fuel_additional&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL_ADDITIONAL</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;reserve_fuel_burned&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RESERVE_FUEL_BURNED</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;reserve_fuel&#39;</span><span class="p">,</span> <span class="n">reserves_name</span><span class="p">)],</span>
        <span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_read_sizing_json</span><span class="p">(</span><span class="n">aviary_problem</span><span class="p">,</span> <span class="n">json_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads in an aviary problem object from a json file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    aviary_problem: OpenMDAO Aviary Problem</span>
<span class="sd">        Aviary problem object optimized for the aircraft design/sizing mission.</span>
<span class="sd">        Assumed to contain aviary_inputs and Mission.Summary.GROSS_MASS</span>
<span class="sd">    json_filename:   string</span>
<span class="sd">        User specified name and relative path of json file to save the data into</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Aviary Problem object with updated input values from json file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load saved input list from json file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_data_file</span><span class="p">:</span>
        <span class="n">loaded_aviary_input_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_data_file</span><span class="p">)</span>
        <span class="n">json_data_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Loop over input list and assign aviary problem input values</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># list index tracker</span>
    <span class="k">for</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="n">loaded_aviary_input_list</span><span class="p">:</span>
        <span class="p">[</span><span class="n">var_name</span><span class="p">,</span> <span class="n">var_values</span><span class="p">,</span> <span class="n">var_units</span><span class="p">,</span> <span class="n">var_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span>

        <span class="c1"># Initialize some flags to identify enums</span>
        <span class="n">is_enum</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">var_type</span> <span class="o">==</span> <span class="s2">&quot;&lt;class &#39;list&#39;&gt;&quot;</span><span class="p">:</span>
            <span class="c1"># check if the list contains enums</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">var_values</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">var_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Found a list of enums: set the flag</span>
                        <span class="n">is_enum</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="c1"># Manipulate the string to find the value</span>
                        <span class="n">tmp_var_values</span> <span class="o">=</span> <span class="n">var_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">var_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">tmp_var_values</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="p">)</span>

            <span class="k">if</span> <span class="n">is_enum</span><span class="p">:</span>
                <span class="n">var_values</span> <span class="o">=</span> <span class="n">convert_strings_to_data</span><span class="p">(</span><span class="n">var_values</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">var_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&lt;enum&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Identify enums and manipulate the string to find the value</span>
            <span class="n">tmp_var_values</span> <span class="o">=</span> <span class="n">var_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">var_values</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">tmp_var_values</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">var_values</span> <span class="o">=</span> <span class="n">convert_strings_to_data</span><span class="p">([</span><span class="n">var_values</span><span class="p">])</span>

        <span class="c1"># Check if the variable is in meta data</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">BaseMetaData</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aviary_problem</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span>
                    <span class="n">var_name</span><span class="p">,</span> <span class="n">var_values</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">var_units</span><span class="p">,</span> <span class="n">meta_data</span><span class="o">=</span><span class="n">BaseMetaData</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="c1"># Print helpful warning</span>
                <span class="c1"># TODO &quot;FAILURE&quot; implies something more serious, should this be a raised</span>
                <span class="c1"># exception?</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;FAILURE: list_num = </span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s1">, Input String = </span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s1">, Attempted &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;to set_value(</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">var_values</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">var_units</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Not in the MetaData</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Name not found in MetaData: list_num = </span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s1">, Input String = &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s1">, Attempted set_value(</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">var_values</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">var_units</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="p">)</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># increment index tracker</span>
    <span class="k">return</span> <span class="n">aviary_problem</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_off_design</span><span class="p">(</span>
    <span class="n">json_filename</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="p">,</span>
    <span class="n">equations_of_motion</span><span class="p">,</span>
    <span class="n">mass_method</span><span class="p">,</span>
    <span class="n">phase_info</span><span class="p">,</span>
    <span class="n">num_first</span><span class="p">,</span>
    <span class="n">num_business</span><span class="p">,</span>
    <span class="n">num_tourist</span><span class="p">,</span>
    <span class="n">num_pax</span><span class="p">,</span>
    <span class="n">wing_cargo</span><span class="p">,</span>
    <span class="n">misc_cargo</span><span class="p">,</span>
    <span class="n">cargo_mass</span><span class="p">,</span>
    <span class="n">mission_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mission_gross_mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbosity</span><span class="o">=</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function loads a sized aircraft, and sets up an aviary problem</span>
<span class="sd">    for a specified off design mission.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    json_filename : str</span>
<span class="sd">        User specified name and relative path of json file containing the sized aircraft data</span>
<span class="sd">    problem_type : ProblemType</span>
<span class="sd">        Alternate or Fallout. Alternate requires mission_range input and fallout</span>
<span class="sd">        requires mission_fuel input</span>
<span class="sd">    equations_of_motion : EquationsOfMotion</span>
<span class="sd">        Which equations of motion will be used for the off-design mission</span>
<span class="sd">    MassMethod : LegacyCode</span>
<span class="sd">        Which legacy code mass method will be used (GASP or FLOPS)</span>
<span class="sd">    phase_info : dict</span>
<span class="sd">        phase_info dictionary for off-design mission</span>
<span class="sd">    num_first : int</span>
<span class="sd">        Number of first class passengers on off-design mission (FLOPS only)</span>
<span class="sd">    num_business : int</span>
<span class="sd">        Number of business class passengers on off-design mission (FLOPS only)</span>
<span class="sd">    num_tourist : int</span>
<span class="sd">        Number of economy class passengers on off-design mission (FLOPS only)</span>
<span class="sd">    num_pax : int</span>
<span class="sd">        Total number of passengers on off-design mission (GASP only)</span>
<span class="sd">    wing_cargo: float</span>
<span class="sd">        Wing-stored cargo mass on off-design mission, in lbm (FLOPS only)</span>
<span class="sd">    misc_cargo : float</span>
<span class="sd">        Miscellaneous cargo mass on off-design mission, in lbm (FLOPS only)</span>
<span class="sd">    cargo_mass : float</span>
<span class="sd">        Total cargo mass on off-design mission, in lbm (GASP only)</span>
<span class="sd">    mission_range : float</span>
<span class="sd">        Total range of off-design mission, in NM</span>
<span class="sd">    mission_gross_mass : float</span>
<span class="sd">        Aircraft takeoff gross mass for off-design mission, in lbm</span>
<span class="sd">    verbosity : Verbosity or list, optional</span>
<span class="sd">        Controls the level of printouts for this method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Aviary Problem object with completed load_inputs() for specified off design mission</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize a new aviary problem and aviary_input data structure</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">AviaryProblem</span><span class="p">()</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span> <span class="o">=</span> <span class="n">AviaryValues</span><span class="p">()</span>

    <span class="n">prob</span> <span class="o">=</span> <span class="n">_read_sizing_json</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">json_filename</span><span class="p">)</span>

    <span class="c1"># Update problem type</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="n">problem_type</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="s1">&#39;settings:problem_type&#39;</span><span class="p">,</span> <span class="n">problem_type</span><span class="p">)</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="s1">&#39;settings:equations_of_motion&#39;</span><span class="p">,</span> <span class="n">equations_of_motion</span><span class="p">)</span>

    <span class="c1"># Setup Payload</span>
    <span class="k">if</span> <span class="n">mass_method</span> <span class="o">==</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">FLOPS</span><span class="p">:</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span>
            <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">NUM_FIRST_CLASS</span><span class="p">,</span> <span class="n">num_first</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span>
        <span class="p">)</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span>
            <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">NUM_BUSINESS_CLASS</span><span class="p">,</span> <span class="n">num_business</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span>
        <span class="p">)</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span>
            <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">NUM_TOURIST_CLASS</span><span class="p">,</span> <span class="n">num_tourist</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span>
        <span class="p">)</span>
        <span class="n">num_pax</span> <span class="o">=</span> <span class="n">num_first</span> <span class="o">+</span> <span class="n">num_business</span> <span class="o">+</span> <span class="n">num_tourist</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">MISC_CARGO</span><span class="p">,</span> <span class="n">misc_cargo</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">WING_CARGO</span><span class="p">,</span> <span class="n">wing_cargo</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
        <span class="n">cargo_mass</span> <span class="o">=</span> <span class="n">misc_cargo</span> <span class="o">+</span> <span class="n">wing_cargo</span>

    <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">NUM_PASSENGERS</span><span class="p">,</span> <span class="n">num_pax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span><span class="p">)</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">CARGO_MASS</span><span class="p">,</span> <span class="n">cargo_mass</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">problem_type</span> <span class="o">==</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">ALTERNATE</span><span class="p">:</span>
        <span class="c1"># Set mission range, aviary will calculate required fuel</span>
        <span class="k">if</span> <span class="n">mission_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                <span class="c1"># TODO text says this is an &quot;ERROR&quot; but methods continues to run, this</span>
                <span class="c1">#      might be confusion</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;ERROR in _load_off_design - Alternate problem type requested with &#39;</span>
                    <span class="s1">&#39;no specified Range&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span> <span class="n">mission_range</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;NM&#39;</span><span class="p">)</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span> <span class="n">mission_range</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;NM&#39;</span><span class="p">)</span>
            <span class="c1"># TODO is there a reason we can&#39;t use set_default() to make sure target range exists and</span>
            <span class="c1">#      has a value if not already in dictionary?</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">phase_info</span><span class="p">[</span><span class="s1">&#39;post_mission&#39;</span><span class="p">][</span><span class="s1">&#39;target_range&#39;</span><span class="p">]</span>
                <span class="n">phase_info</span><span class="p">[</span><span class="s1">&#39;post_mission&#39;</span><span class="p">][</span><span class="s1">&#39;target_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mission_range</span><span class="p">,</span> <span class="s1">&#39;nmi&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;no target range to update&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">problem_type</span> <span class="o">==</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">FALLOUT</span><span class="p">:</span>
        <span class="c1"># Set mission fuel and calculate gross weight, aviary will calculate range</span>
        <span class="k">if</span> <span class="n">mission_gross_mass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>  <span class="c1"># VERBOSE, DEBUG</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Error in _load_off_design - Fallout problem type requested with no &#39;</span>
                    <span class="s1">&#39;specified Gross Mass&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span> <span class="n">mission_gross_mass</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>

    <span class="c1"># Load inputs</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">load_inputs</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span> <span class="n">phase_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prob</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Aviary team at NASA
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>